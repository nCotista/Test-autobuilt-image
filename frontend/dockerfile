# STEP 1: Build React App
FROM node:18-slim AS build

# ติดตั้ง system dependency สำหรับ build (รองรับ node-gyp, bcrypt, sharp ฯลฯ)
RUN apt-get update && apt-get install -y python3 make g++ && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# คัดลอก package.json ก่อน เพื่อให้ layer npm cache ได้
COPY package*.json ./

# แสดงเวอร์ชันเพื่อตรวจสอบ และติดตั้ง dependency
RUN node -v && npm -v && npm install

# คัดลอก source code ที่เหลือ
COPY . .

# สร้าง production build
RUN npm run build

# STEP 2: Serve ด้วย nginx
FROM nginx:alpine

# ลบ default nginx html page
RUN rm -rf /usr/share/nginx/html/*

# คัดลอก build React
COPY --from=build /app/build /usr/share/nginx/html

# หากมี nginx.conf ให้ใช้
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
